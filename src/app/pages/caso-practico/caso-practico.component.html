<ng-container *ngIf="loading; else content">
  <div style="text-align: center; padding: 2rem;">
    <mat-spinner></mat-spinner>
    <p>{{ loading }}</p>
  </div>
</ng-container>

<ng-template #content>
  <mat-card>
    <mat-card-title>Caso Práctico</mat-card-title>
    <mat-card-content>
      <p><strong>Nombre:</strong> {{ data.name }}</p>
      <p><strong>Carrera:</strong> {{ data.career }}</p>
    </mat-card-content>
  </mat-card>

  <app-portada-form
    [title]="practicalCase.title"
    [image]="practicalCase.image"
    (save)="onSavePortada($event.title, $event.image)">
  </app-portada-form>

  <!-- Secciones principales -->
  <ng-container *ngFor="let key of sectionKeys">
    <ng-container *ngIf="key !== 'development'">
      <mat-card style="margin-top: 1rem;">
        <mat-card-title>{{ sectionTitleMap[key] || key }}</mat-card-title>
        <mat-card-content>
          <p *ngIf="practicalCase.sections[key].status">Estado: {{ practicalCase.sections[key].status }}</p>
          <p *ngIf="practicalCase.sections[key].comment" style="color: red;">
            Comentario: {{ practicalCase.sections[key].comment }}
          </p>

          <app-editor-block [(blocks)]="sectionBlocks[key]"></app-editor-block>

          <div style="margin-top: 0.5rem;">
            <button mat-stroked-button color="primary"
              (click)="onSaveSection(practicalCase.sections[key]._id, sectionBlocks[key])">
              Guardar
            </button>
            <button mat-stroked-button color="accent"
              (click)="requestReview(practicalCase.sections[key]._id)">
              Solicitar revisión
            </button>
            <button mat-stroked-button color="warn"
              *ngIf="practicalCase.sections[key].status === 'Aceptado' || practicalCase.sections[key].status === 'En revisión'"
              (click)="returnToWorking(practicalCase.sections[key]._id)">
              Volver a edición
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </ng-container>
  </ng-container>

  <!-- Subetapas de desarrollo -->
  <mat-card style="margin-top: 2rem;">
    <mat-card-title>Desarrollo</mat-card-title>
    <mat-card-content>
      <ng-container *ngFor="let sub of practicalCase.sections.development.subsections; let i = index">
        <mat-card style="margin-top: 1rem;">
          <mat-card-title>{{ sub.name }}</mat-card-title>
          <mat-card-content>
            <p *ngIf="sub.status">Estado: {{ sub.status }}</p>
            <p *ngIf="sub.comment" style="color: red;">Comentario: {{ sub.comment }}</p>

            <app-editor-block [(blocks)]="subsectionBlocks[sub._id]"></app-editor-block>

            <div style="margin-top: 0.5rem;">
              <button mat-stroked-button color="primary"
                (click)="onSaveSection(practicalCase.sections.development._id, subsectionBlocks[sub._id], sub.name)">
                Guardar
              </button>
              <button mat-stroked-button color="accent"
                (click)="requestReview(practicalCase.sections.development._id, sub.name)">
                Solicitar revisión
              </button>
              <button mat-stroked-button color="warn"
                *ngIf="sub.status === 'Aceptado' || sub.status === 'En revisión'"
                (click)="returnToWorking(practicalCase.sections.development._id, sub.name)">
                Volver a edición
              </button>
              <button mat-stroked-button color="warn"
                (click)="deleteSubsection(practicalCase.sections.development._id, sub.name)">
                Eliminar
              </button>
              <button mat-stroked-button (click)="renameSubsection(practicalCase.sections.development._id, sub)">
                Renombrar
              </button>
              <button mat-stroked-button *ngIf="i > 0"
                (click)="moveSection(practicalCase.sections.development._id, sub.name, 'up')">
                Subir
              </button>
              <button mat-stroked-button *ngIf="i < practicalCase.sections.development.subsections.length - 1"
                (click)="moveSection(practicalCase.sections.development._id, sub.name, 'down')">
                Bajar
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      </ng-container>

      <div style="margin-top: 1rem;">
        <button mat-raised-button color="primary" (click)="addSubDevelopment()">Agregar etapa</button>
      </div>
    </mat-card-content>
  </mat-card>

  <div style="margin-top: 2rem;">
    <button mat-raised-button color="accent" (click)="viewPreview()">Vista previa</button>
  </div>

  <div *ngIf="showPreview" style="margin-top: 2rem;">
    <mat-card>
      <mat-card-title>Vista previa</mat-card-title>
      <mat-card-content>
        <iframe
          [src]="previewUrl | safe"
          width="100%"
          height="600px"
          frameborder="0"
          style="border: 1px solid #ccc; border-radius: 4px;">
        </iframe>
      </mat-card-content>
    </mat-card>
  </div>
</ng-template>
